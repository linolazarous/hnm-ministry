/**
 * Heavenly Nature Ministry - Main JavaScript
 * Final version with performance and robustness improvements integrated.
 */

document.addEventListener('DOMContentLoaded', function() {
  
  /**
   * Throttles a function to limit how often it can be called.
   * This improves performance for frequent events like scrolling.
   * @param {Function} callback The function to throttle.
   * @param {number} delay The delay in milliseconds.
   * @returns {Function} The throttled function.
   */
  function throttle(callback, delay = 200) {
    let throttleTimeout = null;
    let storedEvent = null;

    const throttledEventHandler = event => {
      storedEvent = event;
      if (throttleTimeout) return;

      throttleTimeout = setTimeout(() => {
        callback(storedEvent);
        throttleTimeout = null;
      }, delay);
    };

    return throttledEventHandler;
  }

  // ======================
  // Mobile Menu Functionality
  // ======================
  const menuToggle = document.querySelector('.menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileLinks = document.querySelectorAll('.mobile-nav-link');
  
  function toggleMobileMenu() {
    const isExpanded = menuToggle.classList.toggle('is-active');
    mobileMenu.classList.toggle('active');
    document.body.classList.toggle('no-scroll', isExpanded);
    menuToggle.setAttribute('aria-expanded', isExpanded);
  }

  function closeMobileMenu() {
    menuToggle.classList.remove('is-active');
    mobileMenu.classList.remove('active');
    document.body.classList.remove('no-scroll');
    menuToggle.setAttribute('aria-expanded', 'false');
  }

  if (menuToggle && mobileMenu) {
    menuToggle.setAttribute('aria-expanded', 'false');
    menuToggle.setAttribute('aria-controls', 'mobile-menu');
    menuToggle.setAttribute('aria-label', 'Toggle menu');
    
    menuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleMobileMenu();
    });
    
    mobileLinks.forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });

    document.addEventListener('click', function(e) {
      if (mobileMenu.classList.contains('active') && 
          !menuToggle.contains(e.target) && 
          !mobileMenu.contains(e.target)) {
        closeMobileMenu();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
        closeMobileMenu();
      }
    });
  }

  // ======================
  // Animation on Scroll (AOS)
  // ======================
  if (typeof AOS !== 'undefined') {
    AOS.init({
      duration: 800,
      easing: 'ease-in-out',
      once: true,
      offset: 50,
      disable: function() {
        return window.innerWidth < 768;
      }
    });
  }

  // ======================
  // Back to Top Button
  // ======================
  const backToTopButton = document.getElementById('back-to-top');
  if (backToTopButton) {
    function toggleBackToTop() {
      const isVisible = window.scrollY > 300;
      backToTopButton.classList.toggle('show', isVisible);
      backToTopButton.setAttribute('aria-hidden', !isVisible);
    }

    backToTopButton.setAttribute('aria-label', 'Back to top');
    backToTopButton.setAttribute('aria-hidden', 'true');

    // Use the throttled event listener for better performance
    window.addEventListener('scroll', throttle(toggleBackToTop));
    toggleBackToTop(); // Check on initial load

    backToTopButton.addEventListener('click', function(e) {
      e.preventDefault();
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      // Move focus to the top of the page for accessibility
      const header = document.querySelector('header');
      if (header) {
        header.setAttribute('tabindex', '-1');
        header.focus();
      }
    });
  }

  // ======================
  // Smooth Scrolling
  // ======================
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const targetId = this.getAttribute('href');
      
      if (targetId === '#' || targetId === '#!' || targetId.startsWith('javascript:')) {
        return;
      }

      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        e.preventDefault();
        
        const headerHeight = document.querySelector('.site-header')?.offsetHeight || 85;
        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;

        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });

        if (history.pushState) {
          history.pushState(null, null, targetId);
        } else {
          location.hash = targetId;
        }

        targetElement.setAttribute('tabindex', '-1');
        targetElement.focus();
      }
    });
  });

  // ======================
  // Current Year in Footer
  // ======================
  const yearElement = document.getElementById('current-year');
  if (yearElement) {
    yearElement.textContent = new Date().getFullYear();
  }

  // ======================
  // Donation Button Placeholder
  // ======================
  const donationButtons = document.querySelectorAll('#donate .cta-button');
  donationButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      alert('Thank you for your interest in supporting our ministry! Our online donation system is currently being set up. Please check back soon or contact us directly for donation options.');
    });
  });

  // ======================
  // Copy to Clipboard Functionality
  // ======================
  document.querySelectorAll('.copy-button').forEach(button => {
    button.addEventListener('click', function() {
      const textToCopy = this.getAttribute('data-clipboard-text');
      if (!textToCopy) return;

      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
        this.disabled = true;
        setTimeout(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy. Please try again or copy manually.');
      });
    });
  });

  // ======================
  // Lazy Loading for Images
  // ======================
  if ('loading' in HTMLImageElement.prototype) {
    // Native lazy loading supported
    const lazyImages = document.querySelectorAll('img[loading="lazy"]');
    lazyImages.forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
      }
    });
  } else if (typeof LazyLoad !== 'undefined') {
    // Fallback for browsers without native lazy loading
    const lazyLoadInstance = new LazyLoad({
      elements_selector: '[loading="lazy"]',
      threshold: 100
    });
  }
});

    // Set current year in footer
    document.getElementById('current-year').textContent = new Date().getFullYear();
